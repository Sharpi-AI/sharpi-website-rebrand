---
import RecommendationCard from "./recommendation.astro";
import FollowUpCard from "./follow-up.astro";
import NotificationsCard from "./notifications.astro";
import ReactivationCard from "./reactivation.astro";
---

<section id="benefits" aria-labelledby="benefits-title" class=" px-2.5 w-full flex flex-col items-center justify-center overflow-hidden">
  <h2
    id="benefits-title"
    class="pt-28 md:pt-28 text-[37px] md:text-[58px] max-w-[18ch] text-center font-normal leading-none text-[#383838] mb-5 md:mb-14 tracking-tight"
  >
    Nossa IA vende com você e para você.
  </h2>
  <p class="text-sm text-center  tracking-[-0.02em] leading-snug text-[#3D3939] mb-10 md:hidden">A IA da Sharpi envia orçamentos 24/7, liberando seu time para focar em relacionamentos que impulsionam o crescimento.</p>

  <div class="benefits-carousel-container max-w-7xl w-full" role="region" aria-label="Benefícios da IA Sharpi">
    <div class="splide" id="benefits-carousel" aria-roledescription="carrossel">
      <div class="splide__track">
        <ul class="splide__list" role="list">
          <li class="splide__slide">
            <div class="shining-border">
              <RecommendationCard/>
            </div>
          </li>
          <li class="splide__slide">
            <div class="shining-border">
              <ReactivationCard/>
            </div>
          </li>
          <li class="splide__slide">
            <div class="shining-border">
              <NotificationsCard/>
            </div>
          </li>
          <li class="splide__slide">
            <div class="shining-border">
              <FollowUpCard/>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </div>
</section>

<style is:global>
  .benefits-carousel-container {
    width: 100%;
    position: relative;
  }

  #benefits-carousel .splide__track {
    overflow: visible;
  }

  #benefits-carousel .splide__list {
    display: flex;
  }


  .shining-border {
    padding: 2px;
    position: relative;
    overflow: hidden;
    border-radius: 21px;
    transition: all 0.3s ease;
    isolation: isolate;
    contain: layout style paint;
  }

  .splide__slide.is-active .shining-border::before {
    content: "";
    position: absolute;
    z-index: -2;
    left: -50%;
    top: -50%;
    width: 180%;
    height: 180%;
    background-color: #000;
    background-repeat: no-repeat;
    background-size: 100% 100%, 50% 50%;
    background-position: 0 0, 100% 0, 100% 100%, 0 100%;
    background-image: linear-gradient(180deg, #3609FF 0%, #F1F1F1 23.56%, #CFD9FF 44.23%, #7EADFF 100%);
    animation: bgRotate 4s linear infinite;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    will-change: transform;
  }

  .splide__slide.is-active .shining-border::after {
    content: "";
    position: absolute;
    z-index: -1;
    left: 2px;
    top: 2px;
    width: calc(100% - 4px);
    height: calc(100% - 4px);
    background: #F0F0F0;
    border-radius: 20px;
    transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
  }

  @keyframes bgRotate {
    0% {
      transform: translateZ(0) rotate(0deg);
    }
    100% {
      transform: translateZ(0) rotate(360deg);
    }
  }

  .splide__slide.is-active #follow-up-text {
    max-height: 2rem !important;
    opacity: 1;
  }

  .splide__slide.is-active #follow-up-device {
    transform: translateY(-20px);
  }

  .splide__slide.is-active #follow-up-card {
    transform: translateY(-20px);
  }
</style>

<script>
  import { Splide } from "@splidejs/splide";
  import "@splidejs/splide/css/core";

  // Configuration constants
  const MOBILE_BREAKPOINT = 768;
  const MOBILE_GAP = 16;
  const DESKTOP_GAP = 20;
  const CAROUSEL_SPEED = 2000;
  const WHEEL_THRESHOLD = 40;

  const initCarousel = (): void => {
    const carousel = document.getElementById('benefits-carousel');
    if (!carousel) return;

    const isMobile = window.innerWidth <= MOBILE_BREAKPOINT;
    const gap = isMobile ? MOBILE_GAP : DESKTOP_GAP;

    let rafId: number | null = null;

    const updateActiveSlide = () => {
      if (rafId) {
        return;
      }

      rafId = requestAnimationFrame(() => {
        const slides = carousel.querySelectorAll(".splide__slide");
        const container = carousel.closest(".benefits-carousel-container");
        if (!container) {
          rafId = null;
          return;
        }

        const containerRect = container.getBoundingClientRect();
        const containerCenter = containerRect.left + containerRect.width / 2;

        let closestIndex = 0;
        let closestDistance = Number.POSITIVE_INFINITY;

        slides.forEach((slide, i) => {
          const rect = slide.getBoundingClientRect();
          const slideCenter = rect.left + rect.width / 2;
          const distance = Math.abs(containerCenter - slideCenter);

          if (distance < closestDistance) {
            closestDistance = distance;
            closestIndex = i;
          }
        });

        slides.forEach((slide, i) => {
          if (i === closestIndex) {
            slide.classList.add("is-active");
          } else {
            slide.classList.remove("is-active");
          }
        });

        rafId = null;
      });
    };

    const benefitsSplide = new Splide("#benefits-carousel", {
      type: "slide",
      perMove: 1,
      gap,
      autoWidth: true,
      drag: "free",
      snap: false,
      freeScroll: true,
      arrows: false,
      pagination: false,
      speed: CAROUSEL_SPEED,
      breakpoints: {
        [MOBILE_BREAKPOINT]: {
          perPage: 1,
          autoWidth: true,
          snap: true,
        },
      },
    });

    benefitsSplide.on("move", () => {
      updateActiveSlide();
    });

    benefitsSplide.on("moved", () => {
      updateActiveSlide();
    });

    benefitsSplide.mount();

    let wheelDeltaBucket: number = 0;

    const containerEl = carousel.closest('.benefits-carousel-container') as HTMLElement | null;

    const onWheel = (e: WheelEvent) => {
      if (window.innerWidth <= MOBILE_BREAKPOINT) return;
      if (!containerEl) return;

      if (!containerEl.matches(':hover')) return;

      if (e.ctrlKey) return;
      const { deltaX, deltaY } = e;

      const isHorizontalScroll = Math.abs(deltaX) > Math.abs(deltaY);
      
      if (!isHorizontalScroll) {
        return;
      }

      e.preventDefault();
            
      wheelDeltaBucket += deltaX;
      if (Math.abs(wheelDeltaBucket) < WHEEL_THRESHOLD ) return;
      
      if (wheelDeltaBucket > 0) {
        benefitsSplide.go('>');
      } else {
        benefitsSplide.go('<');
      }
      wheelDeltaBucket = 0;
    };

    if (containerEl) {
      const abortController = new AbortController();
      const { signal } = abortController;

      containerEl.addEventListener('wheel', onWheel, { passive: false, signal });

      const cleanup = () => {
        abortController.abort();
      };
      window.addEventListener('pagehide', cleanup, { signal });
      window.addEventListener('beforeunload', cleanup, { signal });
    }

    const slides = carousel.querySelectorAll(".splide__slide");
    if (slides.length > 0) {
      slides[0].classList.add("is-active");
    }

    updateActiveSlide();
  };

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initCarousel);
  } else {
    initCarousel();
  }
</script>